{% extends "core/base.html" %}

{% block title %}Templates Dashboard{% endblock %}

{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/phishing.css' %}">
{% endblock %}

{% block content %}
<div class="container">

  <!-- ================= Header ================= -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <!-- <div>
      <h3 class="fw-bold mb-0">Email Templates</h3>
      <small class="text-muted">
        Manage phishing email templates
      </small>
    </div> -->
    <div class="ph-header">
      <div class="ph-title">
        <span class="ph-bar"></span>
        <h1 class="fw-semibold">Email Templates</h1>
      </div>
    </div>     

    <a href="{% url 'campaigns:create_template' %}" class="btn btn-brand px-4">
      + Create Template
    </a>
  </div>

  <!-- ================= Filters ================= -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <!-- <h5 class="fw-semibold mb-0">All Templates</h5> -->

    <form method="get" class="d-flex gap-2 ms-auto">
      <select name="status" class="form-select form-select-sm">
        <option value="">All Status</option>
        <option value="published" {% if request.GET.status == "published" %}selected{% endif %}>
          Published
        </option>
        <option value="draft" {% if request.GET.status == "draft" %}selected{% endif %}>
          Draft
        </option>
      </select>

      <!-- <button type="submit" class="btn btn-sm btn-outline-dark">
        Filter
      </button> -->
      <button type="submit"
              class="btn btn-filter btn-sm px-3">
              Filter
      </button>
    </form>
  </div>

  <!-- ================= Table ================= -->
  <div class="card border-0 shadow-sm">
    <table class="table mb-0">
      <thead class="table-light">
        <tr>
          <th>Template</th>
          <th>Subject</th>
          <th>Created By</th>
          <th>Created At</th>
          <th>Status</th>
          <th class="text-end">Action</th>
        </tr>
      </thead>

      <tbody>
        {% for template in templates %}
        <tr>
          <!-- Template name + preview -->
          <td>
            <div class="d-flex align-items-center">
              {% if template.preview_image %}
                <img src="{{ template.preview_image.url }}"
                     alt="{{ template.name }}"
                     class="rounded me-2"
                     width="40" height="40">
              {% endif %}
              <strong>{{ template.name }}</strong>
            </div>
          </td>

          <td>{{ template.subject }}</td>

          <td>{{ template.created_by.username|default:"System" }}</td>

          <td>{{ template.created_at|date:"Y-m-d" }}</td>

          <!-- Status -->
          <td>
            {% if not template.is_published %}
              <span class="badge bg-secondary">Draft</span>
            {% elif template.is_published and not template.is_active %}
              <span class="badge bg-warning text-dark">Deactivated</span>
            {% else %}
              <span class="badge bg-success">Published</span>
            {% endif %}
          </td>

          <!-- Actions -->
          <td class="text-end">
            <div class="dropdown">
              <button class="btn btn-sm btn-light"
                      data-bs-toggle="dropdown"
                      aria-expanded="false">
                â‹®
              </button>

              <ul class="dropdown-menu dropdown-menu-end">

                <!-- Draft -->
                {% if not template.is_published %}
                <li>
                  <a class="dropdown-item"
                     href="{% url 'campaigns:edit_template' template.id %}">
                    Edit
                  </a>
                </li>
                {% endif %}

                <!-- Published & Active -->
                {% if template.is_published and template.is_active %}
                <li>
                  <a class="dropdown-item"
                     href="{% url 'campaigns:edit_template' template.id %}">
                    Edit
                  </a>
                </li>

                <li>
                  <a class="dropdown-item"
                     href="#"
                     data-bs-toggle="modal"
                     data-bs-target="#viewCompaniesModal"
                     data-template-id="{{ template.id }}"
                     data-template-name="{{ template.name }}">
                    View Companies
                  </a>
                </li>

                <li>
                  <a class="dropdown-item text-danger"
                     href="{% url 'campaigns:deactivate_template' template.id %}">
                    Deactivate
                  </a>
                </li>
                {% endif %}

                <!-- Deactivated -->
                {% if not template.is_active %}
                <li>
                  <a class="dropdown-item text-success"
                     href="{% url 'campaigns:activate_template' template.id %}">
                    Activate
                  </a>
                </li>
                {% endif %}

              </ul>
            </div>
          </td>
        </tr>

        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted">
            No templates found
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<!-- ================= View Companies Modal ================= -->
<div class="modal fade" id="viewCompaniesModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Published Companies</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p class="text-muted mb-2 small" id="companiesCount"></p>
        <ul id="companiesList" class="list-group list-group-flush">
          <li class="list-group-item text-muted">Loading...</li>
        </ul>
      </div>

    </div>
  </div>
</div>

<!-- ================= JS ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const modal = document.getElementById("viewCompaniesModal");

  modal.addEventListener("show.bs.modal", function (event) {

    const button = event.relatedTarget;
    if (!button) return;

    const templateId = button.getAttribute("data-template-id");

    const countEl = document.getElementById("companiesCount");
    const listEl  = document.getElementById("companiesList");

    countEl.textContent = "";
    listEl.innerHTML = `<li class="list-group-item text-muted">Loading...</li>`;

    fetch(`/campaigns/templates/${templateId}/companies/`)
      .then(res => res.json())
      .then(data => {

        listEl.innerHTML = "";
        countEl.textContent = `${data.companies.length} Companies`;

        if (data.companies.length === 0) {
          listEl.innerHTML = `
            <li class="list-group-item text-muted">
              No companies assigned
            </li>`;
        } else {
          data.companies.forEach(name => {
            listEl.innerHTML += `
              <li class="list-group-item">${name}</li>`;
          });
        }
      })
      .catch(() => {
        listEl.innerHTML = `
          <li class="list-group-item text-danger">
            Failed to load companies
          </li>`;
      });

  });

});
</script>

{% endblock %}
