{% extends 'core/base.html' %}
{% load static %}

{% block title %}Assign Course{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        Assign Course: {{ course.title }}
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        Select companies that should have access to this course. 
                        Employees from selected companies will see this course in their training.
                    </div>
                    
                    <form method="post">
                        {% csrf_token %}
                        
                        {% if all_companies %}
                        <div class="mb-4">
                            <label class="form-label fw-bold">Select Companies:</label>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th width="50">
                                                <input type="checkbox" id="select-all" class="form-check-input">
                                            </th>
                                            <th>Company Name</th>
                                            <th>Status</th>
                                            <th>Currently Assigned</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for company in all_companies %}
                                        <tr>
                                            <td>
                                                <input type="checkbox" 
                                                       name="companies" 
                                                       value="{{ company.id }}"
                                                       id="company_{{ company.id }}"
                                                       class="form-check-input company-checkbox"
                                                       {% if company.id in already_assigned %}checked{% endif %}>
                                            </td>
                                            <td>
                                                <label for="company_{{ company.id }}" class="mb-0">
                                                    <strong>{{ company.name }}</strong><br>
                                                    <small class="text-muted">{{ company.email_domain }}</small>
                                                </label>
                                            </td>
                                            <td>
                                                {% if company.status == 'ACTIVE' %}
                                                <span class="badge bg-success">Active</span>
                                                {% else %}
                                                <span class="badge bg-secondary">{{ company.status }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if company.id in already_assigned %}
                                                <span class="badge bg-success">
                                                    Assigned
                                                </span>
                                                {% else %}
                                                <span class="badge bg-light text-dark">
                                                    Not Assigned
                                                </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span id="selected-count" class="badge bg-primary">0 companies selected</span>
                            </div>
                            <div class="btn-group">
                                <button type="submit" class="btn btn-success">
                                    Save Assignments
                                </button>
                                <a href="{% url 'platform_admin_dashboard' %}" class="btn btn-outline-secondary">
                                    Cancel
                                </a>
                            </div>
                        </div>
                        
                        {% else %}
                        <div class="text-center py-5">
                            <h5>No Companies Available</h5>
                            <p class="text-muted">There are no active companies in the system yet.</p>
                            <a href="/admin/account/company/add/" class="btn btn-primary">
                                Add Company
                            </a>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
            
            <!-- Course Info -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Course Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Title:</strong> {{ course.title }}</p>
                            <p><strong>Category:</strong> {{ course.category.name|default:"None" }}</p>
                            <p><strong>Points:</strong> {{ course.points_reward }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Status:</strong> 
                                {% if course.is_published %}
                                <span class="badge bg-success">Published</span>
                                {% else %}
                                <span class="badge bg-warning">Draft</span>
                                {% endif %}
                            </p>
                            <p><strong>Visibility:</strong> {{ course.get_visibility_display }}</p>
                            <p><strong>Created:</strong> {{ course.created_at|date:"M d, Y" }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Select all checkbox
        const selectAll = document.getElementById('select-all');
        const companyCheckboxes = document.querySelectorAll('.company-checkbox');
        const selectedCount = document.getElementById('selected-count');
        
        function updateSelectedCount() {
            const checked = document.querySelectorAll('.company-checkbox:checked').length;
            selectedCount.textContent = `${checked} companies selected`;
        }
        
        // Select all functionality
        selectAll.addEventListener('change', function() {
            companyCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateSelectedCount();
        });
        
        // Update select all when individual checkboxes change
        companyCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectedCount();
                
                // Update select all checkbox
                const allChecked = Array.from(companyCheckboxes).every(cb => cb.checked);
                const noneChecked = Array.from(companyCheckboxes).every(cb => !cb.checked);
                
                if (allChecked) {
                    selectAll.checked = true;
                } else if (noneChecked) {
                    selectAll.checked = false;
                } else {
                    selectAll.checked = false;
                }
            });
        });
        
        // Initial count update
        updateSelectedCount();
        
        // Set initial state of select all
        const checkedCount = document.querySelectorAll('.company-checkbox:checked').length;
        if (checkedCount === companyCheckboxes.length) {
            selectAll.checked = true;
        } else if (checkedCount === 0) {
            selectAll.checked = false;
        } else {
            selectAll.checked = false;
        }
    });
</script>
{% endblock %}